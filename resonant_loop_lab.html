<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCC - Resonant Loop Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-animate {
            animation: messageSlide 0.3s ease-out;
        }
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">CCC</h1>
            <h2 class="text-xl text-gray-300">Covenant Command Cycle - Resonant Loop Lab</h2>
            <p class="text-sm text-gray-500 mt-2">Multi-Agent Chat Simulation</p>
        </header>

        <!-- Status Indicator -->
        <div class="mb-6">
            <div id="status" class="flex items-center justify-center space-x-2 p-3 rounded-lg bg-gray-800">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="status-text" class="text-sm">Checking connection...</span>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-gray-800 rounded-lg shadow-lg mb-6">
            <!-- Chat Messages -->
            <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 text-sm">
                    Welcome to the Resonant Loop Lab. Start a conversation with the agents!
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-700 p-4">
                <div class="flex space-x-3">
                    <input 
                        id="message-input" 
                        type="text" 
                        placeholder="Enter your message..." 
                        class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 text-white"
                        maxlength="500"
                    >
                    <button 
                        id="send-button" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors"
                        disabled
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Agent Configuration -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold mb-3">Agent Configuration</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Model</label>
                    <select id="model-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Temperature</label>
                    <input 
                        id="temperature-input" 
                        type="range" 
                        min="0" 
                        max="2" 
                        step="0.1" 
                        value="0.7" 
                        class="w-full"
                    >
                    <div class="text-sm text-gray-400 mt-1">
                        Value: <span id="temperature-value">0.7</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4">
            <button 
                id="clear-chat" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors"
            >
                Clear Chat
            </button>
            <button 
                id="simulate-loop" 
                class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors"
            >
                Simulate Loop
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearChatButton = document.getElementById('clear-chat');
        const simulateLoopButton = document.getElementById('simulate-loop');
        const modelSelect = document.getElementById('model-select');
        const temperatureInput = document.getElementById('temperature-input');
        const temperatureValue = document.getElementById('temperature-value');

        // Configuration
        const PROXY_URL = 'http://127.0.0.1:5111';
        let conversationHistory = [];
        let isProcessing = false;

        // Agent configurations for simulation
        const agents = [
            {
                name: 'Analyst',
                role: 'You are an analytical agent focused on breaking down problems and identifying key patterns.',
                color: 'text-blue-400'
            },
            {
                name: 'Synthesizer',
                role: 'You are a synthesis agent focused on combining ideas and creating novel solutions.',
                color: 'text-green-400'
            },
            {
                name: 'Evaluator',
                role: 'You are an evaluation agent focused on assessing ideas and providing critical feedback.',
                color: 'text-yellow-400'
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            setupEventListeners();
            updateTemperatureDisplay();
        });

        // Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            clearChatButton.addEventListener('click', clearChat);
            simulateLoopButton.addEventListener('click', simulateResonantLoop);
            temperatureInput.addEventListener('input', updateTemperatureDisplay);
        }

        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch(`${PROXY_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateStatus('connected', 'Connected to CCC Proxy Server');
                    sendButton.disabled = false;
                } else {
                    throw new Error('Server not healthy');
                }
            } catch (error) {
                updateStatus('disconnected', 'Unable to connect to proxy server');
                console.error('Server connection error:', error);
            }
        }

        // Update status indicator
        function updateStatus(status, message) {
            const colors = {
                connected: 'bg-green-500',
                disconnected: 'bg-red-500',
                processing: 'bg-yellow-500'
            };
            
            statusIndicator.className = `w-3 h-3 rounded-full ${colors[status] || 'bg-gray-500'}`;
            statusText.textContent = message;
        }

        // Update temperature display
        function updateTemperatureDisplay() {
            temperatureValue.textContent = temperatureInput.value;
        }

        // Add message to chat
        function addMessage(sender, content, color = 'text-white') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-animate', 'p-3', 'rounded-lg', 'bg-gray-700');
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="font-semibold ${color}">${sender}:</div>
                    <div class="flex-1">${content}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add typing indicator
        function addTypingIndicator(agent = 'Assistant') {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.classList.add('typing-indicator', 'p-3', 'rounded-lg', 'bg-gray-700', 'text-gray-400');
            typingDiv.innerHTML = `${agent} is thinking...`;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Send message to AI
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            updateStatus('processing', 'Processing message...');
            
            // Add user message
            addMessage('You', message, 'text-blue-400');
            messageInput.value = '';
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            try {
                addTypingIndicator();
                const response = await callOpenAI(conversationHistory);
                removeTypingIndicator();
                
                if (response) {
                    addMessage('Assistant', response, 'text-green-400');
                    conversationHistory.push({ role: 'assistant', content: response });
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('System', `Error: ${error.message}`, 'text-red-400');
                console.error('Error sending message:', error);
            } finally {
                isProcessing = false;
                updateStatus('connected', 'Connected to CCC Proxy Server');
            }
        }

        // Call OpenAI through proxy
        async function callOpenAI(messages, systemPrompt = null) {
            const requestBody = {
                model: modelSelect.value,
                messages: systemPrompt ? [{ role: 'system', content: systemPrompt }, ...messages] : messages,
                temperature: parseFloat(temperatureInput.value),
                max_tokens: 1000
            };

            const response = await fetch(`${PROXY_URL}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Simulate resonant loop between agents
        async function simulateResonantLoop() {
            if (isProcessing) return;
            
            const topic = "the nature of consciousness and artificial intelligence";
            addMessage('System', `Starting resonant loop simulation on: ${topic}`, 'text-purple-400');
            
            isProcessing = true;
            updateStatus('processing', 'Simulating resonant loop...');
            
            try {
                let loopConversation = [
                    { role: 'user', content: `Let's explore ${topic}. Please share your initial thoughts.` }
                ];
                
                // Each agent responds in sequence
                for (let round = 0; round < 2; round++) {
                    for (const agent of agents) {
                        addTypingIndicator(agent.name);
                        
                        const response = await callOpenAI(loopConversation, agent.role);
                        removeTypingIndicator();
                        
                        if (response) {
                            addMessage(agent.name, response, agent.color);
                            loopConversation.push({ role: 'assistant', content: response });
                            
                            // Add the next prompt for continuation
                            if (round < 1 || agent !== agents[agents.length - 1]) {
                                loopConversation.push({ 
                                    role: 'user', 
                                    content: `Building on the previous thoughts, what's your perspective?` 
                                });
                            }
                        }
                        
                        // Small delay between agents
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                addMessage('System', 'Resonant loop simulation complete.', 'text-purple-400');
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('System', `Loop simulation error: ${error.message}`, 'text-red-400');
                console.error('Loop simulation error:', error);
            } finally {
                isProcessing = false;
                updateStatus('connected', 'Connected to CCC Proxy Server');
            }
        }

        // Clear chat
        function clearChat() {
            chatMessages.innerHTML = `
                <div class="text-center text-gray-500 text-sm">
                    Welcome to the Resonant Loop Lab. Start a conversation with the agents!
                </div>
            `;
            conversationHistory = [];
        }
    </script>
</body>
</html>