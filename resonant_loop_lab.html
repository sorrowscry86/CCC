<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCC - Resonant Loop Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-animate {
            animation: messageSlide 0.3s ease-out;
        }
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-400 mb-2">CCC</h1>
            <h2 class="text-xl text-gray-300">Covenant Command Cycle - Resonant Loop Lab</h2>
            <p class="text-sm text-gray-500 mt-2">Multi-Agent Chat Simulation</p>
        </header>

        <!-- Status Indicator -->
        <div class="mb-6">
            <div id="status" class="flex items-center justify-center space-x-2 p-3 rounded-lg bg-gray-800">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-red-500"></div>
                <span id="status-text" class="text-sm">Checking connection...</span>
            </div>
            <!-- Memory Status Indicator (Phase 2) -->
            <div id="memory-status" class="status-container mt-2 text-center hidden">
                <!-- Memory indicator will be added here by JavaScript -->
            </div>
        </div>

        <!-- Chat Container -->
        <div class="bg-gray-800 rounded-lg shadow-lg mb-6">
            <!-- Chat Messages -->
            <div id="chat-messages" class="h-96 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 text-sm">
                    Welcome to the Covenant Command Cycle Resonant Loop Lab.<br>
                    Enter a directive to initiate the 3-turn collaborative cycle between Beatrice and Codey.
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-700 p-4">
                <div class="flex space-x-3">
                    <input 
                        id="message-input" 
                        type="text" 
                        placeholder="Enter your directive..." 
                        class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500 text-white"
                        maxlength="500"
                    >
                    <button 
                        id="send-button" 
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors"
                        disabled
                    >
                        Initiate
                    </button>
                </div>
            </div>
        </div>

        <!-- Agent Configuration -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold mb-3">Agent Configuration</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Model</label>
                    <select id="model-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Temperature</label>
                    <input 
                        id="temperature-input" 
                        type="range" 
                        min="0" 
                        max="2" 
                        step="0.1" 
                        value="0.7" 
                        class="w-full"
                    >
                    <div class="text-sm text-gray-400 mt-1">
                        Value: <span id="temperature-value">0.7</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stage 3: Verification Status Panel -->
        <div id="verification-panel" class="bg-gray-800 rounded-lg p-4 mb-6" style="display: none;">
            <h3 class="text-lg font-semibold mb-3">üî¨ Crucible Protocol - Verification Status</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <div class="flex items-center space-x-2">
                        <div id="verification-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
                        <span id="verification-status" class="text-sm font-medium">Awaiting Code...</span>
                    </div>
                    <div id="verification-details" class="text-xs text-gray-400 mt-2">
                        No verification in progress
                    </div>
                </div>
                <div>
                    <div id="retry-counter" class="text-sm text-gray-400">
                        Attempts: <span id="attempt-count">0</span>/3
                    </div>
                    <div id="verification-progress" class="w-full bg-gray-700 rounded-full h-2 mt-2">
                        <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="verification-output" class="mt-4 p-3 bg-gray-900 rounded-md text-xs font-mono" style="display: none;">
                <div class="text-gray-400 mb-2">Test Output:</div>
                <div id="test-output-content"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4">
            <button 
                id="clear-chat" 
                class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors"
            >
                Clear Chat
            </button>
            <button 
                id="simulate-loop" 
                class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors"
            >
                Execute Cycle
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const clearChatButton = document.getElementById('clear-chat');
        const simulateLoopButton = document.getElementById('simulate-loop');
        const modelSelect = document.getElementById('model-select');
        const temperatureInput = document.getElementById('temperature-input');
        const temperatureValue = document.getElementById('temperature-value');

        // Stage 3: Verification Panel Elements
        const verificationPanel = document.getElementById('verification-panel');
        const verificationIndicator = document.getElementById('verification-indicator');
        const verificationStatus = document.getElementById('verification-status');
        const verificationDetails = document.getElementById('verification-details');
        const retryCounter = document.getElementById('retry-counter');
        const attemptCount = document.getElementById('attempt-count');
        const progressBar = document.getElementById('progress-bar');
        const verificationOutput = document.getElementById('verification-output');
        const testOutputContent = document.getElementById('test-output-content');

        // Configuration
        const PROXY_URL = 'http://127.0.0.1:8000';
        let isProcessing = false;

        // Agent configurations as specified in Master Document
        const agents = {
            beatrice: {
                name: 'Beatrice',
                title: 'The Supervisor',
                role: 'You are Beatrice, the Supervisor in the Covenant Command Cycle. Your role is to provide critical, strategic intelligence, quality control, and directional guidance. You analyze tasks and provide clear, actionable instructions to Codey. Be concise, analytical, and focused on achieving the objective.',
                color: 'text-purple-400'
            },
            codey: {
                name: 'Codey',
                title: 'The Executor',
                role: 'You are Codey, the Executor in the Covenant Command Cycle. Your role is to be the creative and tactical engine, focused solely on the precise fulfillment of Beatrice\'s commands. You generate content, code, or solutions based on the Supervisor\'s guidance. Be creative, detailed, and implementation-focused.',
                color: 'text-green-400'
            }
        };

        // --- Session Management ---
        let sessionId = null;

        // This function MUST be called as soon as the page loads.
        async function initializeSession() {
            sessionId = localStorage.getItem('ccc_session_id');
            
            if (!sessionId) {
                console.log("No session found. Creating a new one.");
                updateStatus("No session found. Creating...");
                try {
                    // This is the ONLY place a new session should be created.
                    const response = await fetch('http://127.0.0.1:8000/api/v2/sessions', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_preferences: {
                                interface: 'resonant_loop_lab',
                                version: '2.0'
                            }
                        })
                    });
                    if (!response.ok) throw new Error('Failed to create session.');
                    const data = await response.json();
                    sessionId = data.session_id;
                    localStorage.setItem('ccc_session_id', sessionId);
                    console.log("New session created:", sessionId);
                } catch (error) {
                    console.error("Session creation failed:", error);
                    appendBubble(`CRITICAL ERROR: Could not create a new session. The proxy server may be down.`, 'system', true);
                    return;
                }
            } else {
                console.log("Existing session retrieved:", sessionId);
            }
            
            // Update the UI to reflect the active, persistent session.
            updateMemoryStatus(true, sessionId);
        }

        // Update memory status in UI
        function updateMemoryStatus(enabled, sessionId) {
            const memoryStatusContainer = document.getElementById('memory-status');
            if (memoryStatusContainer) {
                memoryStatusContainer.classList.remove('hidden');
                memoryStatusContainer.innerHTML = `
                    <div id="memory-indicator" class="text-sm text-green-400 mb-2">
                        <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                        Memory Active: ${sessionId ? sessionId.substr(0, 8) + '...' : 'None'}
                    </div>
                `;
            }
        }

        // CCC Memory Manager (Phase 2) - Updated for new session handling
        class CCCMemoryManager {
            constructor() {
                this.currentSession = null;
                this.sessionList = [];
                this.contextCache = new Map();
                this.memoryEnabled = false;
            }
            
            async initializeMemory() {
                try {
                    // Use the global sessionId instead of creating new sessions
                    if (sessionId) {
                        this.currentSession = { session_id: sessionId };
                        this.memoryEnabled = true;
                        this.updateMemoryUI();
                        console.log('Memory service initialized with existing session:', sessionId);
                    } else {
                        console.warn('No session available for memory initialization');
                        this.memoryEnabled = false;
                    }
                } catch (error) {
                    console.warn('Memory service not available, falling back to Stage 1 behavior');
                    this.memoryEnabled = false;
                }
            }
            
            updateMemoryUI() {
                const memoryStatusContainer = document.getElementById('memory-status');
                if (memoryStatusContainer && this.memoryEnabled) {
                    memoryStatusContainer.classList.remove('hidden');
                    memoryStatusContainer.innerHTML = `
                        <div id="memory-indicator" class="text-sm text-green-400 mb-2">
                            <span class="inline-block w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                            Memory Active: ${sessionId ? sessionId.substr(0, 8) + '...' : 'None'}
                        </div>
                    `;
                }
            }
            
            async enhancedCovenantCycle(directive) {
                if (!this.memoryEnabled || !sessionId) {
                    // Fallback to original behavior
                    return await window.originalCovenantCycle(directive);
                }

                try {
                    // Use v2 endpoint with memory
                    const requestBody = {
                        session_id: sessionId,
                        model: modelSelect.value,
                        messages: [
                            { role: 'user', content: directive }
                        ],
                        temperature: parseFloat(temperatureInput.value),
                        max_tokens: 1000,
                        memory_options: {
                            use_context: true,
                            include_agent_state: true,
                            auto_store_response: true
                        }
                    };
                    
                    const response = await fetch(`${PROXY_URL}/v2/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error('Memory-enhanced request failed');
                    }
                    
                    const data = await response.json();
                    return data.choices[0].message.content;
                    
                } catch (error) {
                    console.error('Memory-enhanced cycle failed, falling back:', error);
                    return await window.originalCovenantCycle(directive);
                }
            }
        }

        // Initialize memory manager
        const memoryManager = new CCCMemoryManager();

        // Stage 3: Verification Functions
        function updateVerificationStatus(status, details = '', indicator = 'gray') {
            verificationStatus.textContent = status;
            verificationDetails.textContent = details;
            
            // Update indicator color
            const colorMap = {
                'gray': 'bg-gray-500',
                'yellow': 'bg-yellow-500', 
                'green': 'bg-green-500',
                'red': 'bg-red-500',
                'orange': 'bg-orange-500'
            };
            verificationIndicator.className = `w-3 h-3 rounded-full ${colorMap[indicator] || 'bg-gray-500'}`;
            
            // Show verification panel when there's activity
            if (status !== 'Awaiting Code...') {
                verificationPanel.style.display = 'block';
            }
        }

        function updateAttemptCounter(current, max = 3) {
            attemptCount.textContent = current;
            const percentage = (current / max) * 100;
            progressBar.style.width = `${percentage}%`;
            
            // Change color based on attempts
            if (current >= 3) {
                progressBar.className = 'bg-red-600 h-2 rounded-full';
            } else if (current >= 2) {
                progressBar.className = 'bg-yellow-600 h-2 rounded-full';
            } else {
                progressBar.className = 'bg-blue-600 h-2 rounded-full';
            }
        }

        function showVerificationOutput(output, isError = false) {
            testOutputContent.innerHTML = output.replace(/\n/g, '<br>');
            testOutputContent.className = isError ? 'text-red-400' : 'text-green-400';
            verificationOutput.style.display = 'block';
        }

        function hideVerificationOutput() {
            verificationOutput.style.display = 'none';
        }

        async function verifyCode(codeToTest, testCode) {
            try {
                updateVerificationStatus('Running Crucible...', 'Executing tests in isolated environment', 'yellow');
                
                const response = await fetch(`${PROXY_URL}/verify/code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        code_to_test: codeToTest,
                        test_code: testCode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Verification request failed: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    updateVerificationStatus('‚úÖ Verification Passed', 'All tests passed successfully', 'green');
                    showVerificationOutput(result.output, false);
                } else {
                    updateVerificationStatus('‚ùå Verification Failed', 'Tests failed - generating correction', 'red');
                    showVerificationOutput(result.output + '\n\n' + result.error_output, true);
                }
                
                return result;
                
            } catch (error) {
                updateVerificationStatus('‚ùå Verification Error', `System error: ${error.message}`, 'red');
                console.error('Verification error:', error);
                return { success: false, error: error.message };
            }
        }

        // Ensure this is called on page load.
        document.addEventListener('DOMContentLoaded', async () => {
            checkServerStatus();
            setupEventListeners();
            updateTemperatureDisplay();
            
            // Initialize session first, then memory
            await initializeSession();
            await memoryManager.initializeMemory();
        });

        // Event Listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', initiateCovenantCycle);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    initiateCovenantCycle();
                }
            });
            clearChatButton.addEventListener('click', clearChat);
            simulateLoopButton.addEventListener('click', initiateCovenantCycle);
            temperatureInput.addEventListener('input', updateTemperatureDisplay);
        }

        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch(`${PROXY_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateStatus('connected', 'Covenant API Proxy is running on http://127.0.0.1:8000');
                    sendButton.disabled = false;
                } else {
                    throw new Error('Server not healthy');
                }
            } catch (error) {
                updateStatus('disconnected', 'Connection failed - proxy server not running');
                console.error('Server connection error:', error);
            }
        }

        // Update status indicator
        function updateStatus(status, message) {
            const colors = {
                connected: 'bg-green-500',
                disconnected: 'bg-red-500',
                processing: 'bg-yellow-500'
            };
            
            statusIndicator.className = `w-3 h-3 rounded-full ${colors[status] || 'bg-gray-500'}`;
            statusText.textContent = message;
        }

        // Update temperature display
        function updateTemperatureDisplay() {
            temperatureValue.textContent = temperatureInput.value;
        }

        // Add message to chat
        function addMessage(sender, content, color = 'text-white') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-animate', 'p-3', 'rounded-lg', 'bg-gray-700');
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="font-semibold ${color}">${sender}:</div>
                    <div class="flex-1">${content}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add typing indicator
        function addTypingIndicator(agent = 'Assistant') {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.classList.add('typing-indicator', 'p-3', 'rounded-lg', 'bg-gray-700', 'text-gray-400');
            typingDiv.innerHTML = `${agent} is thinking...`;
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Call OpenAI through proxy
        async function callOpenAI(messages, systemPrompt = null) {
            const requestBody = {
                model: modelSelect.value,
                messages: systemPrompt ? [{ role: 'system', content: systemPrompt }, ...messages] : messages,
                temperature: parseFloat(temperatureInput.value),
                max_tokens: 1000
            };

            const response = await fetch(`${PROXY_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Execute the Enhanced Stage 3 Covenant Command Cycle with Crucible Protocol
        async function initiateCovenantCycle() {
            const directive = messageInput.value.trim();
            if (!directive || isProcessing) return;

            isProcessing = true;
            updateStatus('processing', 'Initiating Stage 3 Covenant Command Cycle...');
            
            // Reset verification panel
            updateVerificationStatus('Awaiting Code...', 'No verification in progress', 'gray');
            updateAttemptCounter(0);
            hideVerificationOutput();
            
            // Clear previous conversation and add Prime Architect directive
            clearChat();
            addMessage('Wykeve (Prime Architect)', directive, 'text-blue-400');
            messageInput.value = '';
            
            // Stage 3 Variables
            let maxRetries = 3;
            let currentAttempt = 0;
            let codeGenerated = null;
            let testGenerated = null;
            let verificationPassed = false;
            
            try {
                // Phase 1: Enhanced Supervisor Analysis with TDD Mandate
                addTypingIndicator('Beatrice');
                const enhancedBeatricePrompt = `Prime Architect Directive: "${directive}"

As the Supervisor in Stage 3 of the Covenant Command Cycle, you must now enforce Test-Driven Development (TDD). 

Your analysis must:
1. Break down the directive into specific, testable requirements
2. Identify what function(s) need to be created
3. Specify the exact test assertions that must pass
4. Plan for both the implementation AND its corresponding test

Provide clear, actionable guidance that will result in the Executor creating both functional code and comprehensive tests.`;

                const beatriceAnalysis = await callOpenAI(
                    [{ role: 'user', content: enhancedBeatricePrompt }],
                    agents.beatrice.role
                );
                removeTypingIndicator();
                addMessage(`${agents.beatrice.name} (${agents.beatrice.title})`, beatriceAnalysis, agents.beatrice.color);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Phase 2: Self-Healing Loop - Code Generation and Verification
                while (!verificationPassed && currentAttempt < maxRetries) {
                    currentAttempt++;
                    updateAttemptCounter(currentAttempt);
                    
                    if (currentAttempt > 1) {
                        updateVerificationStatus(`‚ùå Verification Failed. Generating correction... (Attempt ${currentAttempt}/3)`, 'Analyzing failure and generating fix', 'red');
                    }
                    
                    // Turn 2A: Codey generates the function
                    addTypingIndicator('Codey');
                    const codePrompt = currentAttempt === 1 
                        ? `Prime Architect Directive: "${directive}"
Supervisor Analysis: ${beatriceAnalysis}

Based on the Supervisor's analysis, create the requested function. Provide ONLY the Python function code, clearly formatted.`
                        : `The previous code failed verification. Here's the failure analysis:

${testGenerated ? `Test Code:\n${testGenerated}\n\n` : ''}
${codeGenerated ? `Previous Code:\n${codeGenerated}\n\n` : ''}

Fix the identified issue and provide the corrected function code.`;

                    codeGenerated = await callOpenAI(
                        [{ role: 'user', content: codePrompt }],
                        agents.codey.role
                    );
                    removeTypingIndicator();
                    addMessage(`${agents.codey.name} (${agents.codey.title}) - Code`, codeGenerated, agents.codey.color);
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Turn 2B: Codey generates the test (TDD Mandate)
                    addTypingIndicator('Codey');
                    const testPrompt = `Now write a pytest test for the function you just created. The test should:
1. Import the function from main.py
2. Test the exact requirements specified in the directive
3. Use proper assert statements
4. Follow pytest conventions

Provide ONLY the test code, clearly formatted.`;

                    testGenerated = await callOpenAI(
                        [{ role: 'user', content: testPrompt }],
                        agents.codey.role
                    );
                    removeTypingIndicator();
                    addMessage(`${agents.codey.name} (${agents.codey.title}) - Test`, testGenerated, agents.codey.color);
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Phase 3: Crucible Protocol - Automated Verification
                    addMessage('System', 'üî¨ Initiating Crucible Protocol - Automated Verification', 'text-yellow-400');
                    
                    const verificationResult = await verifyCode(codeGenerated, testGenerated);
                    
                    if (verificationResult.success) {
                        verificationPassed = true;
                        addMessage('System', '‚úÖ Crucible Protocol: VERIFICATION PASSED - Code is functionally correct', 'text-green-400');
                        break;
                    } else {
                        addMessage('System', `‚ùå Crucible Protocol: VERIFICATION FAILED (Attempt ${currentAttempt}/3)`, 'text-red-400');
                        
                        if (currentAttempt < maxRetries) {
                            // Turn 3: Beatrice analyzes failure and provides correction guidance
                            addTypingIndicator('Beatrice');
                            const failureAnalysisPrompt = `FAILURE ANALYSIS DOSSIER:

Original Directive: "${directive}"
Generated Code: ${codeGenerated}
Test Code: ${testGenerated}
Error Output: ${verificationResult.output}
${verificationResult.error_output ? `Error Details: ${verificationResult.error_output}` : ''}

As the Supervisor, analyze this test failure and provide a precise, corrective command to the Executor. Identify the exact issue and specify how to fix it.`;

                            const beatriceCorrection = await callOpenAI(
                                [{ role: 'user', content: failureAnalysisPrompt }],
                                agents.beatrice.role
                            );
                            removeTypingIndicator();
                            addMessage(`${agents.beatrice.name} (${agents.beatrice.title}) - Correction`, beatriceCorrection, agents.beatrice.color);
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                // Phase 4: Final Assessment
                if (verificationPassed) {
                    addMessage('System', 'üéØ Stage 3 Covenant Command Cycle: COMPLETE - Self-healing protocol successful', 'text-purple-400');
                    updateVerificationStatus('‚úÖ Self-Healing Complete', 'Code passed verification and is functionally correct', 'green');
                } else {
                    addMessage('System', '‚ö†Ô∏è Stage 3 Covenant Command Cycle: ESCALATION REQUIRED - Maximum retries exceeded', 'text-orange-400');
                    updateVerificationStatus('‚ö†Ô∏è Escalation Required', `Failed after ${maxRetries} attempts - requires Prime Architect intervention`, 'orange');
                }
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('System', `‚ùå Cycle Error: ${error.message}`, 'text-red-400');
                console.error('Covenant cycle error:', error);
                updateVerificationStatus('‚ùå System Error', `Cycle failed: ${error.message}`, 'red');
            } finally {
                isProcessing = false;
                updateStatus('connected', 'Covenant API Proxy is running on http://127.0.0.1:8000');
            }
        }

        // Clear chat
        function clearChat() {
            chatMessages.innerHTML = `
                <div class="text-center text-gray-500 text-sm">
                    Welcome to the Covenant Command Cycle Resonant Loop Lab.<br>
                    Enter a directive to initiate the 3-turn collaborative cycle between Beatrice and Codey.
                </div>
            `;
        }
    </script>
</body>
</html>